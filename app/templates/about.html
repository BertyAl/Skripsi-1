{% extends 'base.html' %}
{% block content %}
    <div class="container py-4">
        <h5 class="text-danger">Bukan ajakan untuk membeli saham, lakukan analisa kembali sebelum memutuskan!</h5>
        <h4 class="mt-4">Hasil Optimasi Portofolio</h4>

        {% if df_alloc and df_alloc|length > 0 %}
            <div class="row g-3">
                <div class="col-md-7">
                    <table class="table table-sm">
                        <thead class="table-light">
                        <tr>
                            <th>Ticker</th>
                            <th class="text-end">Bobot</th>
                            <th class="text-end">Nominal (Rp)</th>
                            <th class="text-end">Expected Return</th>
                            <th class="text-end">Risiko</th>
                        </tr>
                        </thead>
                        <tbody>
                        {% for row in df_alloc %}
                            <tr>
                                <td>{{ row.ticker }}</td>
                                <td class="text-end">{{ "%.2f%%"|format(row.weight * 100) }}</td>
                                <td class="text-end">{{ "{:,.0f}".format(row.nominal) }}</td>
                                <td class="text-end">{{ "%.3f%%"|format(row.exp_return * 100) }}</td>
                                <td class="text-end">{{ "%.3f%%"|format(row.asset_sigma * 100) }}</td>
                            </tr>
                        {% endfor %}
                        </tbody>
                    </table>

                    <div class="mt-2 small text-muted">
                        Expected Return Portofolio: <strong>{{ "%.3f%%"|format(summary.exp_return * 100) }}</strong> |
                        Risiko: <strong>{{ "%.3f%%"|format(summary.risk * 100) }}</strong> |
                        Sharpe: <strong>{{ "%.3f"|format(summary.sharpe) }}</strong>
                    </div>
                    {% if summary and (summary.exp_return is not none) and (summary.exp_return < 0) %}
                        <div class="mt-1 small text-danger">
                            ⚠️ Expected return portofolio negatif ({{ "%.3f%%"|format(summary.exp_return * 100) }}).
                            Pertimbangkan mengganti komposisi saham.
                            {# opsional: tampilkan ticker yang exp_return-nya negatif #}
                            {% set neg = df_alloc | selectattr('exp_return', 'lt', 0) | map(attribute='ticker') | list %}
                            {% if neg|length > 0 %}
                                Saham dengan expected return negatif: {{ neg|join(', ') }}.
                            {% endif %}
                        </div>
                    {% endif %}

                </div>

                <div class="col-md-5">
                    <canvas id="allocPie" height="260"></canvas>
                </div>
            </div>
        {% else %}
            <div class="alert alert-warning">Belum ada alokasi (hasil optimasi kosong).</div>
        {% endif %}
        <div class="d-flex align-items-center justify-content-between mb-3">
            <h2 class="h4 mb-0">Hasil Prediksi Saham xLSTM</h2>
            {% if amount is not none %}
                <span class="text-muted small">Dana: Rp {{ "{:,.0f}".format(amount or 0) }}</span>
            {% endif %}
        </div>
        {% if results|length == 0 %}
            <div class="alert alert-warning">Tidak ada hasil untuk ditampilkan.</div>
        {% else %}
            <div class="result-grid">
                {% for res in results %}
                    <div class="card result-card shadow-sm">
                        <div class="card-body p-3">
                            <h5 class="card-title h6 mb-2">{{ res.ticker }}</h5>

                            <ul class="list-unstyled list-compact mb-2">
                                <li>Harga terakhir: <strong>{{ "%.2f"|format(res.last_price) }}</strong></li>
                                <li>Prediksi berikutnya: <strong>{{ "%.2f"|format(res.next_pred) }}</strong></li>
                                <li>MAE: <strong>{{ "%.4f"|format(res.mae) }}</strong></li>
                                <li>RMSE: <strong>{{ "%.4f"|format(res.rmse) }}</strong></li>
                                <li>MAPE: <strong>{{ "%.2f"|format(res.mape) }}%</strong></li>
                            </ul>

{#                            <div class="chart-wrap mb-2">#}
{#                                <canvas id="chart_{{ loop.index }}" height="160"></canvas>#}
{#                            </div>#}

                            <div class="table-responsive mb-2">
                                <table class="table table-sm align-middle mb-0">
                                    <thead>
                                    <tr>
                                        <th>Horizon</th>
                                        <th>Tanggal</th>
                                        <th class="text-end">Prediksi Harga</th>
                                    </tr>
                                    </thead>
                                    <tbody>
                                    <tr>
                                        <td>1 Hari (T+1)</td>
                                        <td>{{ res.pred_1d_date }}</td>
                                        <td class="text-end"><strong>{{ "%.2f"|format(res.pred_1d) }}</strong></td>
                                    </tr>
                                    <tr>
                                        <td>
                                            3 Bulan (≈ 60 hari bursa)
                                            <button class="btn btn-link btn-sm p-0 ms-2" type="button"
                                                    data-bs-toggle="collapse"
                                                    data-bs-target="#tbl3m_{{ loop.index0 }}"
                                                    aria-expanded="false"
                                                    aria-controls="tbl3m_{{ loop.index0 }}">
                                                Lihat rincian
                                            </button>
                                        </td>
                                        <td>{{ res.pred_3mo_date }}</td>
                                        <td class="text-end"><strong>{{ "%.2f"|format(res.pred_3mo) }}</strong></td>
                                    </tr>
                                    </tbody>
                                </table>
                                <div class="form-text mt-1">
                                    Data terakhir: <strong>{{ res.last_date }}</strong> → hari bursa berikutnya: <strong>{{ res.next_bd }}</strong>
                                </div>
                            </div>

                            {% set has_future = (res.future_dates is defined) and (res.future_values is defined)
                                and (res.future_dates|length > 0) and (res.future_values|length > 0) %}
                            {% if has_future %}
                                <div class="collapse" id="tbl3m_{{ loop.index0 }}">
                                    <div class="card card-body border-0 p-0 mt-2">
                                        <div class="table-responsive" style="max-height:260px; overflow-y:auto;">
                                            <table class="table table-sm table-hover mb-0">
                                                <thead class="table-light" style="position:sticky; top:0; z-index:1;">
                                                <tr>
                                                    <th style="width:40%;">Tanggal</th>
                                                    <th class="text-end">Prediksi Harga</th>
                                                </tr>
                                                </thead>
                                                <tbody>
                                                {% for i in range(res.future_dates|length) %}
                                                    <tr>
                                                        <td>{{ res.future_dates[i] }}</td>
                                                        <td class="text-end">{{ "%.2f"|format(res.future_values[i]) }}</td>
                                                    </tr>
                                                {% endfor %}
                                                </tbody>
                                            </table>
                                        </div>
                                        <div class="d-flex justify-content-end mt-2">
                                            <button type="button" class="btn btn-outline-secondary btn-sm"
                                                    onclick="download3MCSV('{{ res.ticker }}', {{ res.future_dates|tojson }}, {{ res.future_values|tojson }})">
                                                Unduh CSV 3 Bulan
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            {% else %}
                                <div class="alert alert-warning mt-2 mb-0 small">
                                    Data prediksi 3 bulan tidak tersedia untuk {{ res.ticker }}.
                                </div>
                            {% endif %}

{#                            {% if logs_per_ticker %}#}
{#                                <details class="small text-muted">#}
{#                                    <summary class="mb-1">Lihat proses training & evaluasi</summary>#}
{#                                    <pre class="mb-0 small" style="white-space:pre-wrap">{{ logs_per_ticker[res.ticker]|join('\n') }}</pre>#}
{#                                </details>#}
{#                            {% endif %}#}
                        </div>
                    </div>
                {% endfor %}
            </div>
        {% endif %}
    </div>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        (function(){
            // Line charts untuk tiap ticker
            {% for res in results %}
                (function(){
                    const el = document.getElementById('chart_{{ loop.index }}');
                    if (!el) return;
                    new Chart(el.getContext('2d'), {
                        type: 'line',
                        data: {
                            labels: Array.from({length: {{ res.actual|length }}}, (_,i)=>i+1),
                            datasets: [
                                {label:'Actual',   data: {{ res.actual|tojson }},  borderWidth: 2, fill: false},
                                {label:'Prediksi', data: {{ res.preds|tojson }},   borderWidth: 2, fill: false}
                            ]
                        },
                        options: { responsive:true, maintainAspectRatio:false,
                            plugins:{ legend:{ position:'bottom', labels:{ boxWidth:16 } } },
                            scales:{ x:{ display:false } }
                        }
                    });
                })();
            {% endfor %}

            // Pie chart alokasi dari df_alloc
            {% if df_alloc and df_alloc|length > 0 %}
                const labels = {{ df_alloc | map(attribute='ticker') | list | tojson }};
                const weights = {{ df_alloc | map(attribute='weight') | list | tojson }};
                const ctxPie = document.getElementById('allocPie');
                if (ctxPie) {
                    new Chart(ctxPie.getContext('2d'), {
                        type: 'pie',
                        data: { labels, datasets: [{ data: weights }] },
                        options: {
                            plugins: {
                                tooltip: { callbacks: { label: (ctx) => `${ctx.label}: ${(ctx.raw*100).toFixed(2)}%` } },
                                legend: { position:'bottom' }
                            }
                        }
                    });
                }
            {% endif %}
        })();
    </script>

    <script>
        function download3MCSV(ticker, dates, values) {
            try {
                if (!Array.isArray(dates) || !Array.isArray(values) || dates.length === 0) {
                    console.warn("No data to export.");
                    return;
                }
                const n = Math.min(dates.length, values.length);
                const header = ["Tanggal", "PrediksiHarga"];

                // RFC 4180-safe CSV quoting
                const quote = (v) => {
                    const s = (v === null || v === undefined) ? "" : String(v);
                    return `"${s.replace(/"/g, '""')}"`;
                };

                // Build rows
                const rows = [header];
                for (let i = 0; i < n; i++) {
                    // keep raw numeric for CSV; format on read if needed
                    const val = Number.isFinite(Number(values[i])) ? Number(values[i]) : values[i];
                    rows.push([dates[i], val]);
                }

                // Join with CRLF (better for Excel/Windows)
                const csvBody = rows.map(r => r.map(quote).join(",")).join("\r\n");

                // Add UTF-8 BOM so Excel detects encoding
                const BOM = "\uFEFF";
                const csv = BOM + csvBody;

                const blob = new Blob([csv], { type: "text/csv;charset=utf-8" });

                // Filename: replace dots to avoid some OS quirks
                const safeTicker = String(ticker || "ticker").replace(/\./g, "_");
                const filename = `prediksi_3bulan_${safeTicker}.csv`;

                // Legacy IE/Edge (very old)
                if (window.navigator && window.navigator.msSaveOrOpenBlob) {
                    window.navigator.msSaveOrOpenBlob(blob, filename);
                    return;
                }

                const url = URL.createObjectURL(blob);
                const a = document.createElement("a");
                a.href = url;
                a.download = filename;
                a.rel = "noopener"; // safety
                document.body.appendChild(a);
                a.click();
                a.remove();
                URL.revokeObjectURL(url);
            } catch (err) {
                console.error("CSV download failed:", err);
            }
        }
    </script>
{% endblock %}
